<!DOCTYPE html>
<html lang="hi">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e2e">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OMR Master Scanner</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { 
            --primary: #2563eb; 
            --primary-dark: #1e40af;
            --success: #16a34a;
            --danger: #dc2626;
            --bg: #f8fafc; 
            --surface: #ffffff;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: #1e293b; 
            margin: 0; 
            padding: 8px; 
            overscroll-behavior: none;
        }
        
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 60px; }
        
        .card { 
            background: var(--surface); 
            padding: 12px; 
            border-radius: 12px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            margin-bottom: 10px; 
            border: 1px solid #e2e8f0; 
        }

        h2 { margin: 0 0 10px 0; color: #0f172a; font-size: 1rem; display: flex; align-items: center; gap: 8px; font-weight: 700; }

        .btn { 
            width: 100%; padding: 10px; border: none; border-radius: 8px; 
            font-weight: 600; cursor: pointer; display: flex; align-items: center; 
            justify-content: center; gap: 6px; font-size: 0.9rem; transition: 0.2s;
        }
        .btn-sm { padding: 6px 10px; font-size: 0.8rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:disabled { background: #94a3b8; }
        .btn-outline { background: transparent; border: 1px solid #cbd5e1; color: #475569; }
        
        .scanner-wrapper { 
            position: relative; 
            width: 100%; 
            min-height: 220px; 
            background: #0f172a; 
            border-radius: 8px; 
            overflow: hidden; 
            margin-bottom: 10px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            display: block; 
        }
        
        canvas { display: block; width: 100%; height: auto; }

        #upload-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: white; pointer-events: none; z-index: 10;
        }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .result-box { display: none; animation: slideUp 0.5s ease-out; margin-top: 15px; border: 2px solid var(--primary); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .result-header {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white; padding: 15px; border-radius: 10px;
            text-align: center; margin-bottom: 12px;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
        }
        
        .score-val { font-size: 2.5rem; font-weight: 800; line-height: 1; margin: 5px 0; }
        .meta-info { display: flex; justify-content: space-between; background: rgba(255,255,255,0.1); padding: 6px; border-radius: 6px; font-size: 0.8rem; margin-top: 10px; }

        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .stat-item { background: #f8fafc; padding: 8px 4px; border-radius: 6px; text-align: center; border: 1px solid #e2e8f0; }
        .st-num { font-size: 1.1rem; font-weight: 800; display: block; }
        .st-lbl { font-size: 0.6rem; color: #64748b; font-weight: 700; text-transform: uppercase; }
        
        .c-green { color: var(--success); } .c-red { color: var(--danger); } .c-yellow { color: #d97706; } .c-gray { color: #64748b; }

        .answer-section { margin-top: 15px; border-top: 1px dashed #cbd5e1; padding-top: 10px; }
        .detected-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(32px, 1fr)); gap: 4px; 
            max-height: 250px; overflow-y: auto; padding: 5px;
            background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 6px;
        }
        .d-cell { font-size: 9px; text-align: center; padding: 4px 0; background: #fff; border-radius: 3px; border:1px solid #e2e8f0; color: #475569; font-weight: 600; }
        .d-cell.filled { background: var(--primary); color: white; border-color:var(--primary); }
        .d-cell.deleted { opacity: 0.6; background: #94a3b8 !important; color: #fff; text-decoration: line-through; border: 1px dashed #475569; }

        .helper-text { font-size: 0.75rem; color: #334155; margin-bottom: 8px; text-align: center; background: #e0f2fe; padding: 8px; border-radius: 6px; border: 1px solid #bae6fd; }
        .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 35px; height: 35px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- LOGIN & ONLINE DATA CSS --- */
        .login-overlay { position: fixed; inset: 0; background: #f1f5f9; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; border: 1px solid #cbd5e1; }
        .login-inp { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; outline: none; font-size: 0.9rem; }
        .online-box { background: #eff6ff; border: 1px dashed #3b82f6; border-radius: 8px; padding: 8px; margin-bottom: 12px; display: none; text-align: left; }
        .ob-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 0.8rem; }
        .ob-lbl { font-size: 0.65rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
        .ob-val { font-weight: 700; color: #0f172a; }

        /* --- PRINT CSS (Page 1 & Page 2 Fixed) --- */
        #print-container { display: none; }

        @media print {
            @page { margin: 5mm; size: A4; }
            body > *:not(#print-container) { display: none !important; }
            #print-container { 
                display: block !important; 
                position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 5px; 
                background: white; font-family: sans-serif; color: black; z-index: 9999;
            }
            .page-break { page-break-before: always; display: block; margin-top: 20px; }
            
            .print-header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #1e40af; padding-bottom: 10px; }
            .print-score { border: 1px solid #1e40af; padding: 10px; border-radius: 8px; background: #f3f4f6 !important; -webkit-print-color-adjust: exact; margin-bottom: 15px; }
            
            /* --- UPDATED PRINT OMR STYLES --- */
            .print-omr-wrapper { 
                text-align: center; 
                width: 100%; 
                /* Height ‡§ï‡§Æ ‡§ï‡§∞ ‡§¶‡•Ä (24cm -> 19cm) ‡§§‡§æ‡§ï‡§ø ‡§™‡•á‡§ú ‡§¨‡•ç‡§∞‡•á‡§ï ‡§® ‡§π‡•ã */
                max-height: 19cm; 
                overflow: hidden; 
                border: 1px solid #eee; 
                display: flex; 
                justify-content: center; 
                align-items: flex-start;
                margin-bottom: 5px; 
                margin-top: 5px;
            }
            
            img#print-omr-img { 
                /* Width 80% ‡§ï‡§∞ ‡§¶‡•Ä ‡§§‡§æ‡§ï‡§ø ‡§∏‡§æ‡§á‡§°‡•ç‡§∏ ‡§∏‡•á ‡§∏‡•ç‡§™‡•á‡§∏ ‡§∞‡§π‡•á */
                max-width: 70%; 
                max-height: 80%; 
                object-fit: contain; 
            }
            
            /* Page 2 Grid Styling */
            .p2-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; font-size: 9px; }
            .p2-cell { border: 1px solid #ccc; padding: 4px; text-align: center; border-radius: 2px; }
            .p2-filled { background: #1e40af !important; color: white !important; -webkit-print-color-adjust: exact; }
            .p2-del { background: #94a3b8 !important; color: white; text-decoration: line-through; -webkit-print-color-adjust: exact; }
            
            /* Page 2 Info Table */
            .p2-info-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 15px; }
            .p2-info-table td { border: 1px solid #ccc; padding: 5px; }
            .p2-info-table b { color: #1e40af; }
        }
      /* --- PAPER VIEW CSS --- */
        .q-block { margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .q-text { font-size: 11px; font-weight: 700; color: #1e293b; margin-bottom: 4px; }
        .q-opts { display: grid; grid-template-columns: 1fr; gap: 2px; }
        .opt-row { font-size: 10px; padding: 2px 5px; border-radius: 3px; display: flex; gap: 5px; }
        
        /* Status Colors */
        .opt-correct { background-color: #dcfce7; color: #166534; font-weight: 600; border: 1px solid #86efac; } /* Green */
        .opt-wrong { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; } /* Red */
        /* User Selection Styles */
        .opt-user { background-color: #eff6ff; border: 1px solid #bfdbfe; } 
        
        /* NEW: Option E (Skipped) Style - Blue & Distinct */
        .opt-skipped { 
            background-color: #dbeafe !important; /* Light Blue */
            border: 1px solid #2563eb !important; /* Dark Blue Border */
            color: #1e40af !important; 
            font-weight: 600;
        }

        /* Print Fixes */
        @media print {
            /* Ensure Page 3 is visible when active */
            #print-page-3[style*="block"] { display: block !important; }
            .opt-skipped { -webkit-print-color-adjust: exact; background-color: #dbeafe !important; }
        } /* Blue (User Selection) */
        
        .badge-del { background: #94a3b8; color: white; padding: 1px 4px; font-size: 8px; border-radius: 3px; margin-left: 5px; }

        @media print {
            .paper-print-box { font-size: 10px; font-family: serif; }
            .q-block { break-inside: avoid; page-break-inside: avoid; border-bottom: 1px dashed #ccc; }
            .opt-correct { border: 1px solid #000; font-weight: bold; background: #eee !important; -webkit-print-color-adjust: exact; } 
            /* Print me color save karne ke liye simple bold rakh sakte hain */
        }

        @media (max-width: 768px) {
            .mobile-paste-btn { display: flex !important; align-items: center; justify-content: center; background: #fff; color: var(--primary); border-color: var(--primary); }
            .controls { grid-template-columns: 1fr auto 1fr; gap: 6px; }
        }
    </style>
</head>
<body>

<div id="authScreen" class="login-overlay">
    <div class="login-card">
        <h3 style="color:#2563eb; margin:0 0 10px 0;">SECURE LOGIN</h3>
        <p style="font-size:0.8rem; color:#64748b; margin-bottom:15px;">Enter credentials</p>
        <input type="email" id="uEmail" class="login-inp" placeholder="Admin Email">
        <input type="password" id="uPass" class="login-inp" placeholder="Password">
        <button class="btn btn-primary" onclick="adminLogin()">UNLOCK</button>
        <p id="lMsg" style="color:red; font-size:0.75rem; margin-top:8px; display:none;"></p>
    </div>
</div>

<div class="container">
    <div class="card" id="scanner-card">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0; color:#0f172a; font-size:1.1rem; display:flex; align-items:center; gap:8px; font-weight:800;">
                <i class="fas fa-bullseye" style="color:var(--primary);"></i> OMR Scanner
            </h2>
            <button onclick="softReset()" style="background:#f1f5f9; border:1px solid #cbd5e1; color:#64748b; width:24px; height:24px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:0.2s;" title="Reset All">
                <i class="fas fa-redo-alt" style="font-size:14px;"></i>
            </button>
        </div>

        <div style="margin-bottom: 15px; max-width: 100%;">
            
            <div style="display:flex; align-items:center; background:white; border:1px solid #cbd5e1; border-radius:50px; padding:2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
               <input type="number" id="inp-online-roll" placeholder="Roll Number" onkeydown="if(event.key==='Enter') findOMRImage()"
       style="flex:1; border:none; outline:none; padding:8px 20px; font-size:14px; background:transparent; border-radius:50px 0 0 50px;">
                <button onclick="findOMRImage()" style="background:var(--primary); color:white; border:none; padding:8px 20px; border-radius:50px; cursor:pointer; font-weight:600; font-size:14px; margin:2px;">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <div id="search-status" style="font-size:11px; font-weight:600; margin-top:5px; text-align:center; display:none;"></div>

          <div id="preview-box" style="display:none; margin-top:12px; background:#dcfce7; padding:6px 8px 6px 20px; border-radius:50px; border:1px solid #86efac; align-items:center; justify-content:space-between; box-shadow: 0 4px 10px rgba(22, 163, 74, 0.15);">
    <div style="font-weight:700; color:#15803d; font-size:0.85rem; display:flex; align-items:center; gap:8px;">
        <i class="fas fa-check-circle" style="font-size:1.1rem;"></i> OMR Found
    </div>
    
    <button onclick="downloadOMR()" style="background:#1e293b; color:white; border:none; padding:8px 18px; border-radius:50px; cursor:pointer; font-size:0.8rem; font-weight:600; display:flex; align-items:center; gap:6px; transition:0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
        <i class="fas fa-download"></i> Download
    </button>
</div>
        </div>
        
        <div class="scanner-wrapper" id="scan-wrap" onclick="if(!imgObj.src) document.getElementById('fileIn').click()">
            <canvas id="omrCanvas"></canvas>
            <div id="upload-hint">
                <i class="fas fa-camera" style="font-size:24px; opacity:0.8; margin-bottom:5px;"></i>
                <div style="font-size:12px; font-weight:600;">Tap to Upload / Paste</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-outline" onclick="document.getElementById('fileIn').click()">
                <i class="fas fa-upload"></i> Re-Up
            </button>
            <button class="btn btn-outline mobile-paste-btn" onclick="handleMobilePaste()" style="display:none; width:auto; padding:0 12px;">
                <i class="fas fa-paste"></i>
            </button>
            <input type="file" id="fileIn" accept="image/*,application/pdf" style="display:none" onchange="handleFileSelect(this)">
            
            <button class="btn btn-primary" id="scanBtn" onclick="processScan()" disabled>
                <i class="fas fa-bolt"></i> Scan
            </button>
        </div>
    </div>

    <div class="card result-box" id="result-card">
        
        <div id="onlineDataBox" class="online-box">
            <div style="border-bottom:1px solid #bfdbfe; padding-bottom:5px; margin-bottom:5px; font-weight:800; color:#1e40af; font-size:0.75rem; display:flex; justify-content:space-between;">
                <span>SERVER DATA (4TH GRADE)</span>
                <span id="on-status" style="color:#d97706;">SEARCHING...</span>
            </div>
            <div class="ob-grid">
                <div><div class="ob-lbl">Name</div><div class="ob-val" id="on-name">--</div></div>
                <div><div class="ob-lbl">Rank</div><div class="ob-val" id="on-rank" style="color:#9333ea;">--</div></div>
                <div><div class="ob-lbl">Father</div><div class="ob-val" id="on-father">--</div></div>
                <div><div class="ob-lbl">Mother</div><div class="ob-val" id="on-mother">--</div></div>
                <div><div class="ob-lbl">Category</div><div class="ob-val" id="on-cat">--</div></div>
                <div><div class="ob-lbl">Gender</div><div class="ob-val" id="on-gender">--</div></div>
            </div>
            <div style="margin-top:6px; padding-top:5px; border-top:1px dashed #bfdbfe; display:grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size:0.8rem;">
    <div><span class="ob-lbl">Raw:</span> <span id="on-raw" style="font-weight:800; color:#2563eb;">--</span></div>
    <div><span class="ob-lbl">Final:</span> <span id="on-final" style="font-weight:800; color:#16a34a;">--</span></div>
</div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-size:0.8rem; font-weight:700; color:#c2410c;">SET: <span id="detected-set">--</span></div>
            <button class="btn btn-outline btn-sm" style="width:auto;" onclick="softReset()">
                <i class="fas fa-redo"></i> Reset
            </button>
        </div>

        <div class="result-header">
            <div class="score-val" id="res-score">0.00</div>
            <div style="font-size:0.7rem; opacity:0.9;">OMR Scan Score (Raw)</div>
         <div class="meta-info">
                <div onclick="openRollPopup()" style="cursor:pointer;" title="Tap to Edit Roll No">
                    Roll: <b id="res-roll">--</b>
                </div>
                <div>Booklet: <b id="res-booklet">--</b></div>
            </div>
            <div style="margin-top:5px; font-size:0.7rem; background:rgba(0,0,0,0.2); padding:3px; border-radius:4px;" id="res-shift">Detecting...</div>
        </div>
          <div id="rollPopup" class="login-overlay" style="display:none; background:rgba(0,0,0,0.8);">
    <div class="login-card" style="max-width:280px;">
        <h3 style="margin-top:0; color:#2563eb;">Correct Roll No.</h3>
        <p style="font-size:0.8rem; color:#64748b; margin-bottom:15px;">Enter correct 7-digit Roll Number to re-check result.</p>
        
        <input type="number" id="popup-roll-inp" class="login-inp" placeholder="Ex: 1234567" style="font-size:1.2rem; text-align:center; letter-spacing:2px; font-weight:bold;">
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-outline" onclick="document.getElementById('rollPopup').style.display='none'">Cancel</button>
            <button class="btn btn-primary" onclick="submitRollUpdate()">Update & Check</button>
        </div>
    </div>
</div>
        <div class="stats-grid">
            <div class="stat-item"><span class="st-num c-green" id="res-correct">0</span><span class="st-lbl">Right</span></div>
            <div class="stat-item"><span class="st-num c-red" id="res-wrong">0</span><span class="st-lbl">Wrong</span></div>
            <div class="stat-item"><span class="st-num c-yellow" id="res-skip">0</span><span class="st-lbl">Skip</span></div>
            <div class="stat-item"><span class="st-num c-gray" id="res-deleted">0</span><span class="st-lbl">Del</span></div>
        </div>
        
        <div class="answer-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <label style="font-size:0.75rem; display:flex; align-items:center; gap:5px; cursor:pointer;">
                    <input type="checkbox" id="print-answers-opt"> 
                    <span>Print Answer Key</span>
                </label>
                <button class="btn btn-outline btn-sm" style="width:auto;" onclick="toggleAnswerGrid()">
                    <i class="fas fa-eye"></i> View Answers
                </button>
            </div>
            
            <div id="preview-grid-wrapper" style="display:none;">
                 <div class="detected-grid" id="detected-grid"></div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px; border-top:1px dashed #cbd5e1; padding-top:10px;">
                <label style="font-size:0.75rem; display:flex; align-items:center; gap:5px; cursor:pointer;">
                    <input type="checkbox" id="print-paper-opt"> 
                    <span>Print Question Paper</span>
                </label>
                <button class="btn btn-outline btn-sm" style="width:auto;" onclick="togglePaperView()">
                    <i class="fas fa-file-alt"></i> View Paper
                </button>
            </div>
            
            <div id="paper-view-wrapper" style="display:none; margin-top:15px; background:#fff; padding:10px; border:1px solid #e2e8f0; border-radius:8px; max-height:400px; overflow-y:auto;">
                 <div id="paper-renderer"></div>
            </div>
        </div>

        <button class="btn btn-primary" onclick="triggerPrint()" style="margin-top:10px; background:#1e293b;">
            <i class="fas fa-print"></i> Print Report
        </button>
    </div>
</div>
</div>

<div id="print-container">
    <div class="print-page-1">
        <div class="print-header">
            <div style="font-size: 20px; font-weight: 900; text-transform: uppercase; color: #1e40af;">Result Report 4th Class</div>
            <div style="font-size:11px; color:#555;"> OMR Evaluation by MP SALODIYA | Date: <span id="p-date"></span></div>
        </div>

        <div id="print-extra-info" style="display:none; margin-bottom:10px; border:1px solid #1e293b; border-radius:8px; padding:8px; font-size:11px; text-align:left; background:#f8fafc; -webkit-print-color-adjust: exact;">
            <div style="border-bottom:1px dashed #cbd5e1; padding-bottom:4px; margin-bottom:4px; font-weight:bold; color:#1e40af;">SERVER RECORD DETAILS</div>
            <table style="width:100%; border-collapse:collapse;">
                <tr>
                    <td style="padding:3px; width:50%;"><b>Name:</b> <span id="p-on-name"></span></td>
                    <td style="padding:3px; width:50%; color:#9333ea;"><b>Rank:</b> <span id="p-on-rank" style="font-weight:900;"></span></td>
                </tr>
                <tr>
                    <td style="padding:3px;"><b>Father:</b> <span id="p-on-father"></span></td>
                    <td style="padding:3px;"><b>Mother:</b> <span id="p-on-mother"></span></td>
                </tr>
                <tr>
                    <td style="padding:3px;"><b>Cat:</b> <span id="p-on-cat"></span></td>
                    <td style="padding:3px;">
                        <b>Raw:</b> <span id="p-on-raw"></span> | 
                        <b>Final:</b> <span id="p-on-final"></span>
                    </td>
                </tr>
            </table>
        </div>

        <div class="print-score">
            <div style="display: flex; justify-content: space-around; border-bottom: 1px solid #ddd; padding-bottom: 8px;">
                <div style="text-align:center;">
                    <span id="p-score" style="font-size: 24px; font-weight: 800; color: #1e40af; display:block;">0.00</span>
                    <span style="font-size: 9px; text-transform: uppercase; font-weight: bold;">OMR RAW Score</span>
                </div>
                <div style="text-align:center; color:#16a34a;">
                    <span id="p-correct" style="font-size: 20px; font-weight: 800; display:block;">0</span>
                    <span style="font-size: 9px; text-transform: uppercase; font-weight: bold;">Correct</span>
                </div>
                <div style="text-align:center; color:#dc2626;">
                    <span id="p-wrong" style="font-size: 20px; font-weight: 800; display:block;">0</span>
                    <span style="font-size: 9px; text-transform: uppercase; font-weight: bold;">Wrong</span>
                </div>
                <div style="text-align:center; color:#d97706;">
                    <span id="p-skip" style="font-size: 20px; font-weight: 800; display:block;">0</span>
                    <span style="font-size: 9px; text-transform: uppercase; font-weight: bold;">Skip</span>
                </div>
                <div style="text-align:center; color:#64748b;">
                    <span id="p-deleted" style="font-size: 20px; font-weight: 800; display:block;">0</span>
                    <span style="font-size: 9px; text-transform: uppercase; font-weight: bold;">Deleted</span>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #333; font-weight: 600; margin-top:10px;">
                <div>Roll: <span id="p-roll" style="font-weight: 800; font-size: 12px;"></span></div>
                <div>Booklet: <span id="p-booklet" style="font-weight: 800; font-size: 12px;"></span></div>
                <div>Set: <span id="p-set" style="font-weight: 800; font-size: 12px; color:#d97706;"></span></div>
                <div>Shift: <span id="p-shift"></span></div>
            </div>
        </div>

        <div style="font-size:10px; font-weight:bold; margin-bottom:5px; margin-top:10px; border-bottom:1px solid #ccc;">Clean OMR Scan Proof:</div>
        <div class="print-omr-wrapper">
            <img id="print-omr-img" alt="OMR Scan">
        </div>
    </div>

    <div id="print-page-2" class="page-break" style="display:none;">
        <div class="print-header">
            <div style="font-size: 18px; font-weight: 900; text-transform: uppercase; color: #1e40af;">Answer Key Analysis</div>
        </div>
        
        <table class="p2-info-table">
            <tr>
                <td><b>Name:</b> <span id="p2-name"></span></td>
                <td><b>Rank:</b> <span id="p2-rank"></span></td>
                <td><b>Category:</b> <span id="p2-cat"></span></td>
            </tr>
            <tr>
                <td><b>Roll No:</b> <span id="p2-roll"></span></td>
                <td><b>Shift:</b> <span id="p2-shift"></span></td>
                <td><b>Set:</b> <span id="p2-set"></span></td>
            </tr>
            <tr>
                <td colspan="3" style="text-align:center; background:#f0f9ff; font-weight:bold; font-size:12px;">
                    Raw Score: <span id="p2-score" style="color:#2563eb;"></span> &nbsp;|&nbsp; 
                    Final Score: <span id="p2-final" style="color:#16a34a;"></span>
                </td>
            </tr>
        </table>
        
        <div style="font-size:10px; margin-bottom:10px; color:#444;">
            <b>Legend:</b> <span style="background:#1e40af; color:#fff; padding:1px 4px;">Blue = Your Ans</span> | 
            <span style="text-decoration:line-through; background:#94a3b8; color:#fff; padding:1px 4px;">Strike = Deleted</span> |
            <span style="border:1px solid red; padding:1px 4px;">Red Border = Blank</span>
        </div>

        <div id="print-answers-grid" class="p2-grid"></div>
    </div>

    <div id="print-page-3" class="page-break" style="display:none;">
        <div class="print-header">
            <div style="font-size: 18px; font-weight: 900; text-transform: uppercase; color: #1e40af;">Candidate Question Paper Report</div>
            <div style="font-size: 11px;">
                Set: <span id="p3-set"></span> | 
                Raw: <span id="p3-score"></span> | 
                Final: <span id="p3-final" style="font-weight:800; color:#16a34a;"></span>
            </div>
        </div>
        <div id="print-paper-renderer" class="paper-print-box"></div>
    </div>

<div class="loading" id="loader">
    <div class="spinner"></div>
    <p style="margin-top:15px; font-weight:600; color:#475569;">Processing...</p>
</div>

<script src="questions-data.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAiLtCapS9zH6JMA_S3EpRm84kR90IUALI",
        authDomain: "examdata.firebaseapp.com",
        databaseURL: "https://examdata-default-rtdb.firebaseio.com",
        projectId: "examdata",
        storageBucket: "examdata.firebasestorage.app",
        messagingSenderId: "658962316072",
        appId: "1:658962316072:web:9b78511acbe17f97a6ee1d"
    };

    let db, auth;

    function initSystem() {
        if (typeof firebase === 'undefined') return;
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        auth = firebase.auth();
        auth.onAuthStateChanged(user => {
            document.getElementById('authScreen').style.display = user ? 'none' : 'flex';
        });
    }

    function adminLogin() {
        if (!auth) initSystem();
        const e = document.getElementById('uEmail').value;
        const p = document.getElementById('uPass').value;
        const m = document.getElementById('lMsg');
        
        if(!e || !p) { m.innerText="Required!"; m.style.display='block'; return; }
        m.style.display='none';
        
        if(auth) {
            auth.signInWithEmailAndPassword(e, p).catch(err => {
                m.innerText = "Invalid Credentials";
                m.style.display='block';
            });
        } else {
            m.innerText = "Retrying...";
            initSystem();
        }
    }

    async function getStudentData(roll) {
        if(!roll || !db) return;
        
        const box = document.getElementById('onlineDataBox');
        const printBox = document.getElementById('print-extra-info');
        
        box.style.display = 'block';
        document.getElementById('on-status').innerText = "SEARCHING...";
        
        const fields = ['on-name','on-rank','on-father','on-mother','on-cat','on-gender','on-raw','on-final'];
        fields.forEach(id => document.getElementById(id).innerText = '--');

        try {
            const snap = await db.ref('exams/fourthgrade2025/byroll/' + roll).once('value');
            if(snap.exists()) {
                const d = snap.val();
                
                document.getElementById('on-name').innerText = d.candidate || '-';
                document.getElementById('on-father').innerText = d.father || '-';
                document.getElementById('on-mother').innerText = d.mother || '-';
                document.getElementById('on-cat').innerText = d.category || '-';
                document.getElementById('on-gender').innerText = d.gender || '-';
                
                let rankVal = d.merit ? `#${d.merit}` : (d.rank ? `#${d.rank}` : 'NA');
                document.getElementById('on-rank').innerText = rankVal;

                let rawScore = d.raw ? parseFloat(d.raw).toFixed(4) : 'NA';
                let finalScoreFmt = parseFloat(d.normalized || d.raw || 0).toFixed(4);

                document.getElementById('on-raw').innerText = rawScore;
                document.getElementById('on-final').innerText = finalScoreFmt;
                document.getElementById('on-status').innerText = "FOUND ‚úî";
                document.getElementById('on-status').style.color = "#16a34a";

                printBox.style.display = 'block';
                document.getElementById('p-on-name').innerText = d.candidate || '-';
                document.getElementById('p-on-rank').innerText = rankVal;
                document.getElementById('p-on-father').innerText = d.father || '-';
                document.getElementById('p-on-mother').innerText = d.mother || '-';
                document.getElementById('p-on-cat').innerText = d.category || '-';
                document.getElementById('p-on-raw').innerText = rawScore;
                document.getElementById('p-on-final').innerText = finalScoreFmt;
                
                // PAGE 2 DATA
                document.getElementById('p2-name').innerText = d.candidate || '-';
                document.getElementById('p2-rank').innerText = rankVal;
                document.getElementById('p2-cat').innerText = d.category || '-';

            } else {
                document.getElementById('on-status').innerText = "NOT FOUND";
                document.getElementById('on-status').style.color = "#dc2626";
                printBox.style.display = 'none';
                document.getElementById('p2-name').innerText = "Not Found";
                document.getElementById('p2-rank').innerText = "-";
            }
        } catch(err) {
            console.error(err);
        }
    }

    function toggleAnswerGrid() {
        const grid = document.getElementById('preview-grid-wrapper');
        const btn = document.querySelector('.answer-section button i');
        if(grid.style.display === 'none') {
            grid.style.display = 'block';
            btn.className = 'fas fa-eye-slash';
        } else {
            grid.style.display = 'none';
            btn.className = 'fas fa-eye';
        }
    }

    const GRID_ROWS = 43;
    const GRID_COLS = 37;
    const SHIFT_RANGES = [
        { id: 'shift1', min: 110101, max: 1521943, label: '19 Sep - Shift 1' },
        { id: 'shift2', min: 1521944, max: 1933786, label: '19 Sep - Shift 2' },
        { id: 'shift3', min: 1933787, max: 2345629, label: '20 Sep - Shift 3' },
        { id: 'shift4', min: 2345630, max: 2757472, label: '20 Sep - Shift 4' },
        { id: 'shift5', min: 2757473, max: 3169315, label: '21 Sep - Shift 5' },
        { id: 'shift6', min: 3169316, max: 3581166, label: '21 Sep - Shift 6' }
    ];

    let corners = [{x:0.04, y:0.04}, {x:0.96, y:0.04}, {x:0.96, y:0.96}, {x:0.04, y:0.96}];
    let canvas, ctx, imgObj = new Image();
    let detectedRoll = "", detectedBooklet = "", detectedAnswers = new Array(120).fill(null);
    const optionsList = ['A', 'B', 'C', 'D', 'E'];


/* --- FINAL WORKING OMR LOGIC --- */

// ‡§∂‡§ø‡§´‡•ç‡§ü‡•ç‡§∏ ‡§ï‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü (‡§Ø‡§π ‡§ï‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§¨‡§∏ ‡§è‡§ï ‡§π‡•Ä ‡§¨‡§æ‡§∞ ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è)
const OMR_SHIFTS = ['SHIFT1', 'SHIFT2', 'SHIFT3', 'SHIFT4', 'SHIFT5', 'SHIFT6'];
let foundOMRUrl = ""; // ‡§∏‡§π‡•Ä URL ‡§ï‡•ã ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è

function findOMRImage() {
  	document.getElementById('inp-online-roll').blur();
    const roll = document.getElementById('inp-online-roll').value.trim();
    const statusDiv = document.getElementById('search-status');
    const previewBox = document.getElementById('preview-box');
    const previewImg = document.getElementById('omr-preview-img');
    const btn = document.querySelector('button[onclick="findOMRImage()"]');

    if(!roll) return alert("Please enter a Roll Number");

    // UI Reset
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    statusDiv.style.display = 'block';
    statusDiv.innerText = "Searching...";
    statusDiv.style.color = "#d97706"; 
    previewBox.style.display = 'none';
    foundOMRUrl = "";

    let shiftsChecked = 0;
    let found = false;

    // Direct Image Checking (Like OMR get.html)
    OMR_SHIFTS.forEach(shift => {
        if(found) return;

        // ‡§∏‡•Ä‡§ß‡§æ ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ï‡§æ ‡§≤‡§ø‡§Ç‡§ï (No Proxy yet) - ‡§Ø‡§π "OMR get.html" ‡§ú‡•à‡§∏‡§æ ‡§§‡§∞‡•Ä‡§ï‡§æ ‡§π‡•à
        const url = `https://rssbasonline.com/images/${shift}/${shift}/${roll}.jpg`;
        
        const img = new Image();
        img.onload = () => {
            if(!found) {
                found = true;
                foundOMRUrl = url; 
                
                // Status message ko chupana (taki duplicate na dikhe)
                statusDiv.style.display = 'none';

                // New Compact Bar ko dikhana (Flex mode me)
                previewBox.style.display = 'flex';
                
                // Button Reset
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i>';

                // üî• AUTOMATIC TRIGGER üî•
                pasteToCanvas();
            }
        };

        img.onerror = () => {
            shiftsChecked++;
            if(shiftsChecked === OMR_SHIFTS.length && !found) {
                statusDiv.innerText = "OMR Not Found in any shift.";
                statusDiv.style.color = "#dc2626";
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i>';
            }
        };

        img.src = url; // ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞
    });
}

function pasteToCanvas() {
    if (!foundOMRUrl) return;

    // ‡§∏‡•Ä‡§ß‡§æ ‡§≤‡•ã‡§°‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç (‡§¨‡§ü‡§® ‡§¢‡•Ç‡§Å‡§¢‡§®‡•á ‡§ï‡•Ä ‡§ú‡§∞‡•Å‡§∞‡§§ ‡§®‡§π‡•Ä‡§Ç)
    document.getElementById('loader').style.display = 'flex';

    // Proxy URL (High Speed)
    const proxyUrl = `https://wsrv.nl/?url=${encodeURIComponent(foundOMRUrl)}&output=jpg`;

    const img = new Image();
    img.crossOrigin = "Anonymous"; 
    
    img.onload = () => {
        loadToCanvas(img);
        
        // ‡§á‡§Æ‡•á‡§ú ‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§∏‡•Ä‡§ß‡§æ ‡§ï‡•à‡§®‡§µ‡§∏ ‡§ï‡•Ä ‡§§‡§∞‡§´ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç
        document.getElementById('scan-wrap').scrollIntoView({behavior: "smooth"});
    };

    img.onerror = () => {
        // ‡§Ö‡§ó‡§∞ ‡§≤‡•ã‡§° ‡§® ‡§π‡•ã ‡§™‡§æ‡§è ‡§§‡•ã ‡§≤‡•ã‡§°‡§∞ ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
        document.getElementById('loader').style.display = 'none';
        alert("Image load failed. Please try downloading and uploading manually.");
    };

    img.src = proxyUrl;
}
  /* --- SOFT RESET FUNCTION (No Reload) --- */
function softReset() {
    // 1. ‡§∞‡§ø‡§ú‡§≤‡•ç‡§ü ‡§î‡§∞ ‡§™‡•ç‡§∞‡•Ä‡§µ‡•ç‡§Ø‡•Ç ‡§õ‡§ø‡§™‡§æ‡§è‡§Ç
    document.getElementById('result-card').style.display = 'none';
    document.getElementById('preview-box').style.display = 'none';
    document.getElementById('search-status').style.display = 'none';
    document.getElementById('paper-view-wrapper').style.display = 'none';
    document.getElementById('preview-grid-wrapper').style.display = 'none';

    // 2. ‡§á‡§®‡§™‡•Å‡§ü‡•ç‡§∏ ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('inp-online-roll').value = '';
    document.getElementById('fileIn').value = '';
    
    // 3. ‡§ï‡•à‡§®‡§µ‡§æ‡§∏ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (Clear Image)
    imgObj = new Image(); // ‡§á‡§Æ‡•á‡§ú ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç
    foundOMRUrl = "";     // URL ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç
    
    // ‡§ï‡•à‡§®‡§µ‡§æ‡§∏ ‡§ï‡•ã ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç
    if(ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡§ø‡§Ç‡§ü ‡§µ‡§æ‡§™‡§∏ ‡§≤‡§æ‡§è‡§Ç
    document.getElementById('upload-hint').style.display = 'block';
    
    // ‡§∏‡•ç‡§ï‡•à‡§® ‡§¨‡§ü‡§® ‡§°‡§ø‡§∏‡•á‡§¨‡§≤ ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('scanBtn').disabled = true;

    // 4. ‡§¨‡§ü‡§®‡•ç‡§∏ ‡§ï‡•ã ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (Icon ‡§µ‡§æ‡§™‡§∏ ‡§≤‡§æ‡§è‡§Ç)
    const viewBtn = document.querySelector('.answer-section button i');
    if(viewBtn) viewBtn.className = 'fas fa-eye';

    // 5. ‡§ä‡§™‡§∞ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
function loadToCanvas(imgElement) {
    imgObj = imgElement; 

    const wrap = document.getElementById('scan-wrap');
    canvas.width = wrap.clientWidth;
    
    // ‡§∏‡§π‡•Ä ‡§π‡§æ‡§á‡§ü ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    if(imgElement.naturalWidth > 0) {
        canvas.height = canvas.width * (imgElement.naturalHeight / imgElement.naturalWidth);
    } else {
        canvas.height = 300; // Fallback
    }
    
    // ‡§á‡§Æ‡•á‡§ú ‡§°‡•ç‡§∞‡§æ ‡§ï‡§∞‡•á‡§Ç
    if(ctx) ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);
    
    // UI ‡§Ö‡§™‡§°‡•á‡§ü‡•ç‡§∏
    document.getElementById('upload-hint').style.display = 'none';
    document.getElementById('scanBtn').disabled = false;
    document.getElementById('loader').style.display = 'none';
    
    // --- LAYOUT FIX (Auto Save) ---
    // ‡§™‡§π‡§≤‡•á ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡•Ç‡§ú‡§∞ ‡§®‡•á ‡§™‡§π‡§≤‡•á ‡§ï‡•ã‡§à ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó ‡§∏‡•á‡§µ ‡§ï‡•Ä ‡§π‡•à?
    const savedLayout = localStorage.getItem('omr_fixed_v4');
    
    if (savedLayout) {
        // ‡§Ö‡§ó‡§∞ ‡§∏‡•á‡§µ ‡§π‡•à, ‡§§‡•ã ‡§µ‡§π‡•Ä ‡§Ø‡•Ç‡§ú‡§º ‡§ï‡§∞‡•á‡§Ç
        corners = JSON.parse(savedLayout);
    } else {
        // ‡§Ö‡§ó‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§°‡§ø‡§´‡•â‡§≤‡•ç‡§ü ‡§ï‡•ã‡§®‡•ã‡§Ç ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        corners = [{x:0.04, y:0.04}, {x:0.96, y:0.04}, {x:0.96, y:0.96}, {x:0.04, y:0.96}];
    }
    
    draw(); // ‡§Ö‡§¨ ‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏ ‡§°‡•ç‡§∞‡§æ ‡§ï‡§∞‡•á‡§Ç
}
    window.onload = function() {
        initSystem();
        if (typeof allShiftData === 'undefined') alert("Data file missing!");
        
        canvas = document.getElementById('omrCanvas');
        ctx = canvas.getContext('2d');
        loadLayout();
        
        ['mousedown', 'touchstart'].forEach(e => canvas.addEventListener(e, startDrag, {passive: false}));
        ['mousemove', 'touchmove'].forEach(e => canvas.addEventListener(e, drag, {passive: false}));
        ['mouseup', 'touchend'].forEach(e => canvas.addEventListener(e, endDrag));
        window.addEventListener('resize', resizeCanvas);
    };

    // --- PASTE HANDLER (GLOBAL FIX) ---
    document.addEventListener('paste', function(e) {
        const items = e.clipboardData.items;
        let blob = null;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                blob = items[i].getAsFile();
                e.preventDefault();
                break;
            }
        }
        if (blob) processFile(blob);
    });

    function resizeCanvas() {
        const wrap = document.querySelector('.scanner-wrapper');
        if(wrap && canvas) {
            canvas.width = wrap.clientWidth;
            canvas.height = (imgObj.src && imgObj.naturalWidth > 0) ? canvas.width * (imgObj.naturalHeight / imgObj.naturalWidth) : 220;
            draw();
        }
    }

    function draw() {
        if(!ctx) return;
        ctx.clearRect(0,0, canvas.width, canvas.height);
        if(imgObj.src) ctx.drawImage(imgObj, 0, 0, canvas.width, canvas.height);
        
        ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2;
        ctx.beginPath();
        if(corners.length === 4) {
            ctx.moveTo(corners[0].x * canvas.width, corners[0].y * canvas.height);
            for(let i=1; i<4; i++) ctx.lineTo(corners[i].x * canvas.width, corners[i].y * canvas.height);
            ctx.closePath(); ctx.stroke();
        }

        ctx.fillStyle = '#00ff00'; 
        const dotRadius = Math.max(2, canvas.width * 0.007);
        for (let r = 0; r < GRID_ROWS - 1; r++) { 
            for (let c = 0; c < GRID_COLS; c++) {
                // Relevant logic updated: sab jagah +1 kiya hai
                let isRelevant = 
                    (r>=1 && r<=10 && c>=1 && c<=7) ||  // Roll No (Shifted)
                    (r>=1 && r<=10 && c>=10 && c<=17) || // Booklet (Shifted)
                    (r>=12 && ((c>=3 && c<=7) || (c>=12 && c<=16) || (c>=21 && c<=25) || (c>=30 && c<=34))); // Answers (Shifted)
                
                if (isRelevant) {
                    let pt = getGridPoint(r, c);
                    ctx.beginPath(); ctx.arc(pt.x, pt.y, dotRadius, 0, Math.PI*2); ctx.fill();
                }
            }
        }
        
        corners.forEach(p => {
            ctx.beginPath(); ctx.arc(p.x*canvas.width, p.y*canvas.height, 8, 0, Math.PI*2);
            ctx.fillStyle='#dc2626'; ctx.fill(); ctx.strokeStyle='white'; ctx.stroke();
        });
    }

    function getGridPoint(row, col) {
        // Simple logic wapis laye kyuki ab hum GRID size badha chuke h
        let u = (col) / (GRID_COLS - 1), v = (row) / (GRID_ROWS - 1);
        let xTop = corners[0].x + (corners[1].x - corners[0].x) * u;
        let yTop = corners[0].y + (corners[1].y - corners[0].y) * u;
        let xBot = corners[3].x + (corners[2].x - corners[3].x) * u;
        let yBot = corners[3].y + (corners[2].y - corners[3].y) * u;
        return { x: (xTop + (xBot - xTop) * v) * canvas.width, y: (yTop + (yBot - yTop) * v) * canvas.height };
    }
  
    let activeCorner = -1;
    function startDrag(e) {
        if(!imgObj.src) return;
        if(e.cancelable) e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        const px = (cx - rect.left) / rect.width, py = (cy - rect.top) / rect.height;
        activeCorner = corners.findIndex(p => Math.hypot(p.x - px, p.y - py) < 30/rect.width);
    }
    function drag(e) {
        if(activeCorner === -1) return;
        if(e.cancelable) e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        corners[activeCorner] = {
            x: Math.max(0, Math.min(1, (cx - rect.left) / rect.width)), 
            y: Math.max(0, Math.min(1, (cy - rect.top) / rect.height))
        };
        draw();
    }
    function endDrag() { if(activeCorner!==-1) localStorage.setItem('omr_fixed_v4', JSON.stringify(corners)); activeCorner = -1; }
    function loadLayout() { try { corners = JSON.parse(localStorage.getItem('omr_fixed_v4')) || corners; } catch(e){} }

    async function processFile(file) {
        if (!file) return;
        document.getElementById('loader').style.display = 'flex';
        
        if (file.type === 'application/pdf') {
            try {
                const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
                const page = await pdf.getPage(1);
                const vp = page.getViewport({ scale: 2.0 });
                const cvs = document.createElement('canvas'); cvs.width = vp.width; cvs.height = vp.height;
                await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
                imgObj.src = cvs.toDataURL('image/jpeg', 0.9);
            } catch (e) { alert("PDF Error"); document.getElementById('loader').style.display='none'; return; }
        } else {
            const reader = new FileReader();
            reader.onload = e => imgObj.src = e.target.result;
            reader.readAsDataURL(file);
        }
        imgObj.onload = () => {
            document.getElementById('upload-hint').style.display='none';
            document.getElementById('scanBtn').disabled=false;
            resizeCanvas();
            document.getElementById('loader').style.display='none';
        }
    }
    
    function handleFileSelect(inp) { processFile(inp.files[0]); }
    async function handleMobilePaste() {
        try {
            const items = await navigator.clipboard.read();
            for (const item of items) {
                if (item.types[0].startsWith('image/')) { processFile(await item.getType(item.types[0])); return; }
            }
        } catch(e){}
    }

    function processScan() {
        document.getElementById('loader').style.display = 'flex';
        setTimeout(() => {
            const dCvs = document.createElement('canvas');
            dCvs.width = imgObj.naturalWidth; dCvs.height = imgObj.naturalHeight;
            const dCtx = dCvs.getContext('2d');
            dCtx.drawImage(imgObj, 0, 0);

            const getVal = (r, c) => {
                let u = c/(GRID_COLS-1), v = r/(GRID_ROWS-1);
                let xT = corners[0].x + (corners[1].x-corners[0].x)*u, yT = corners[0].y + (corners[1].y-corners[0].y)*u;
                let xB = corners[3].x + (corners[2].x-corners[3].x)*u, yB = corners[3].y + (corners[2].y-corners[3].y)*u;
                let px = Math.floor((xT + (xB-xT)*v) * dCvs.width), py = Math.floor((yT + (yB-yT)*v) * dCvs.height);
                try {
                    let d = dCtx.getImageData(px-2, py-2, 5, 5).data, sum=0;
                    for(let i=0; i<d.length; i+=4) sum += (d[i]*0.3 + d[i+1]*0.59 + d[i+2]*0.11);
                    return sum/(d.length/4);
                } catch(e) { return 255; }
            };

           detectedRoll = "";
            // Pehle c=0 tha, ab c=1 (1 chodkar)
            for(let c=1; c<=7; c++) {
                let min=255, d="?";
                // Row bhi 0 ki jagah 1 se start
                for(let r=1; r<=10; r++) { let v=getVal(r,c); if(v<min){ min=v; if(v<155) d=['1','2','3','4','5','6','7','8','9','0'][r-1]; } }
                detectedRoll += d;
            }

            detectedBooklet = "";
            // Booklet column 9 ki jagah 10 se start
            for(let c=10; c<=17; c++) {
                let min=255, d="?";
                for(let r=1; r<=10; r++) { let v=getVal(r,c); if(v<min){ min=v; if(v<155) d=['1','2','3','4','5','6','7','8','9','0'][r-1]; } }
                detectedBooklet += d;
            }
            detectedBooklet = detectedBooklet.replace(/\?+$/, '');

            detectedAnswers.fill(null);
            // Options ke columns bhi +1 shift ho gaye (2->3, 11->12, etc)
            [{c:3,o:0},{c:12,o:30},{c:21,o:60},{c:30,o:90}].forEach(b => {
                for(let r=0; r<30; r++) {
                    let min=255, best=null;
                    // Yaha row start 11 ki jagah 12 se (Top Margin)
                    for(let o=0; o<5; o++) { let v=getVal(12+r, b.c+o); if(v<min){ min=v; if(v<145) best=optionsList[o]; } }
                    detectedAnswers[b.o+r] = best;
                }
            });

            calculateResult();
            document.getElementById('loader').style.display='none';
            document.getElementById('result-card').style.display='block';
            document.getElementById('result-card').scrollIntoView({ behavior: 'smooth' });
        }, 200);
    }

  function calculateResult() {
        // 1. Result UI me Roll Number dikhana (Input box hatakar wapis text kar diya)
        const rollEl = document.getElementById('res-roll');
        if(rollEl) rollEl.innerText = detectedRoll;
        
        document.getElementById('res-booklet').innerText = detectedBooklet;
        
        // 2. Data fetch call
        getStudentData(detectedRoll);

        // 3. Shift Detection Logic
        let rNum = parseInt(detectedRoll.replace(/\D/g, ''));
        let shift = SHIFT_RANGES.find(s => rNum >= s.min && rNum <= s.max);
        
        if(shift) {
            document.getElementById('res-shift').innerText = shift.label;
            document.getElementById('res-shift').style.background = '#595FFF';
            if(typeof allShiftData !== 'undefined') autoCalculateBestSet(allShiftData[shift.id]);
        } else {
            document.getElementById('res-shift').innerText = "Check Roll No";
            document.getElementById('res-shift').style.background = '#fee2e2';
        }
    }

    // --- POPUP JS FUNCTIONS ---

    function openRollPopup() {
        // Popup kholne ka code
        const currentRoll = document.getElementById('res-roll').innerText;
        const popup = document.getElementById('rollPopup');
        const inp = document.getElementById('popup-roll-inp');
        
        // Value set karein
        inp.value = currentRoll.replace(/\D/g,''); 
        
        // Popup dikhayein (Flex use karein taaki center ho)
        popup.style.display = 'flex';
        
        // Input par focus karein
        setTimeout(() => inp.focus(), 100);
    }

    function submitRollUpdate() {
        const inp = document.getElementById('popup-roll-inp');
        const newRoll = inp.value.trim();
        
        if(!newRoll || newRoll.length < 5) {
            alert("Please enter valid Roll Number");
            return;
        }

        // 1. UI Update
        document.getElementById('res-roll').innerText = newRoll;
        document.getElementById('rollPopup').style.display = 'none';
        
        // 2. Data Fetch
        getStudentData(newRoll);

        // 3. Shift check & Re-calculate
        let rNum = parseInt(newRoll);
        let shift = SHIFT_RANGES.find(s => rNum >= s.min && rNum <= s.max);

        if(shift) {
            document.getElementById('res-shift').innerText = shift.label;
            document.getElementById('res-shift').style.background = '#595FFF';
            
            if(typeof allShiftData !== 'undefined') {
                autoCalculateBestSet(allShiftData[shift.id]);
                alert("Updated! Shift: " + shift.label);
            }
        } else {
            document.getElementById('res-shift').innerText = "Range Error";
            document.getElementById('res-shift').style.background = '#fee2e2';
            alert("Roll number shift range se bahar hai!");
        }
    }

    function autoCalculateBestSet(sData) {
        const validQ = sData.questions.length - sData.questions.filter(q => q.deleted).length;
        const mpq = validQ > 0 ? (200 / validQ) : 0;
        const neg = mpq / 3;
        const blankPen = mpq / 3;

        let bestScore = -Infinity, bestSet = "", bestStats = {};
        Object.keys(sData.seriesOrder).forEach(set => {
            let st = getScore(set, sData, mpq, neg, blankPen);
            if(st.score > bestScore) { bestScore = st.score; bestSet = set; bestStats = st; }
        });

        document.getElementById('detected-set').innerText = bestSet;
        document.getElementById('res-score').innerText = bestScore.toFixed(4);
        document.getElementById('res-correct').innerText = bestStats.c;
        document.getElementById('res-wrong').innerText = bestStats.w;
        document.getElementById('res-skip').innerText = bestStats.s;
        if(bestStats.u>0) document.getElementById('res-skip').innerHTML = `${bestStats.s} <span style="font-size:0.5rem; color:red">(${bestStats.u} Blank)</span>`;
        document.getElementById('res-deleted').innerText = bestStats.d;

        // Render Grids
        renderGrid('detected-grid', bestSet, sData, false); // Screen
        renderGrid('print-answers-grid', bestSet, sData, true); // Print Page 2
      	renderGrid('detected-grid', bestSet, sData, false); 
        renderGrid('print-answers-grid', bestSet, sData, true);
        
        // NEW: Paper Render Call
        renderFullPaper('paper-renderer', bestSet, sData);      // For Screen
        renderFullPaper('print-paper-renderer', bestSet, sData); // For Print
    }

    function renderGrid(containerId, set, sData, isPrint) {
        const grid = document.getElementById(containerId);
        grid.innerHTML = '';
        const qOrder = sData.seriesOrder[set];
        
        detectedAnswers.forEach((ans, i) => {
            let d = document.createElement('div');
            let baseClass = isPrint ? 'p2-cell' : 'd-cell';
            let filledClass = isPrint ? 'p2-filled' : 'filled';
            let delClass = isPrint ? 'p2-del' : 'deleted';
            
            let cls = baseClass + (ans ? ' ' + filledClass : '');
            
            if (qOrder && qOrder[i]) {
                const mQ = sData.questions[qOrder[i] - 1];
                if (mQ && mQ.deleted) cls += ' ' + delClass;
            }
            if(!ans) d.style.border = "1px solid red";

            d.className = cls;
            d.innerText = (i+1) + (ans ? ':' + ans : '');
            grid.appendChild(d);
        });
    }

    function getScore(set, sData, mpq, neg, blankPen) {
        let c=0, w=0, s=0, d=0, u=0;
        const qOrder = sData.seriesOrder[set];
        const optCfg = sData.seriesOptionOrder ? sData.seriesOptionOrder[set] : null;

        qOrder.forEach((mIdx, uIdx) => {
            if (uIdx >= detectedAnswers.length) return;
            const mQ = sData.questions[mIdx - 1];
            
            if (mQ.deleted) { d++; return; }
            const uAns = detectedAnswers[uIdx];
            
            if (!uAns) { u++; return; }
            if (uAns === 'E') { s++; return; }

            let pat = [0,1,2,3,4];
            if (optCfg) pat = (Array.isArray(optCfg) ? optCfg : (optCfg[mQ.id] || optCfg['default'] || pat));
            
            const vIdx = optionsList.indexOf(uAns);
            const mOptIdx = pat[vIdx];
            
            if (!mQ.options[mOptIdx]) { w++; return; }
            const sel = mQ.options[mOptIdx].substring(3).trim();
            const cor = mQ.answer.substring(3).trim();
            (sel === cor) ? c++ : w++;
        });

        return { score: (c*mpq)-(w*neg)-(u*blankPen), c, w, s, d, u };
    }

 function triggerPrint() {
        const d = new Date().toLocaleDateString();
        document.getElementById('p-date').innerText = d;
        
        // 1. Populate Basic Info (Page 1)
        ['roll','booklet','shift','score','correct','wrong','deleted','skip'].forEach(id => {
            const el = document.getElementById('p-'+id);
            const source = document.getElementById('res-'+id);
            if(el && source) el.innerText = source.innerText;
        });
        
        const setVal = document.getElementById('detected-set').innerText;
        document.getElementById('p-set').innerText = setVal;
        
        // 2. Fetch FINAL SCORE from Online Data Box
        // (Ye element 'onlineDataBox' ke andar hota h jo firebase se data aane par bharta h)
        let finalScoreVal = document.getElementById('on-final').innerText;
        if(!finalScoreVal || finalScoreVal === '--') finalScoreVal = "Pending/NA";

        // Set Image Source
        if(imgObj.src) document.getElementById('print-omr-img').src = imgObj.src;

        // --- PAGE 2 CONFIG (Answer Key) ---
        const includeAnswers = document.getElementById('print-answers-opt').checked;
        const page2 = document.getElementById('print-page-2');
        
        if(includeAnswers) {
            page2.style.display = 'block';
            document.getElementById('p2-roll').innerText = document.getElementById('res-roll').innerText;
            document.getElementById('p2-shift').innerText = document.getElementById('res-shift').innerText;
            document.getElementById('p2-set').innerText = setVal;
            
            // Set Scores
            document.getElementById('p2-score').innerText = document.getElementById('res-score').innerText; // Raw
            document.getElementById('p2-final').innerText = finalScoreVal; // Final
        } else {
            page2.style.display = 'none';
        }

        // --- PAGE 3 CONFIG (Question Paper) ---
        const includePaper = document.getElementById('print-paper-opt').checked;
        const page3 = document.getElementById('print-page-3');

        if(includePaper) {
            page3.style.display = 'block';
            document.getElementById('p3-set').innerText = setVal;
            
            // Set Scores
            document.getElementById('p3-score').innerText = document.getElementById('res-score').innerText; // Raw
            document.getElementById('p3-final').innerText = finalScoreVal; // Final
        } else {
            page3.style.display = 'none';
        }

        setTimeout(() => window.print(), 300);
    }
  
 function togglePaperView() {
        const wrap = document.getElementById('paper-view-wrapper');
        const renderer = document.getElementById('paper-renderer');
        const btn = document.querySelector('button[onclick="togglePaperView()"] i');
        
        // Validation: Check if content is generated
        if(renderer.innerHTML.trim() === "") {
            alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á OMR Sheet ‡§ï‡•ã Scan ‡§ï‡§∞‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø Paper generate ‡§π‡•ã ‡§∏‡§ï‡•á‡•§");
            return;
        }

        if(wrap.style.display === 'none') {
            wrap.style.display = 'block';
            btn.className = 'fas fa-eye-slash';
        } else {
            wrap.style.display = 'none';
            btn.className = 'fas fa-file-alt';
        }
    }

  function renderFullPaper(containerId, set, sData) {
        const container = document.getElementById(containerId);
        if(!container) return;
        container.innerHTML = '';

        if(!sData || !sData.seriesOrder || !sData.seriesOrder[set]) {
            container.innerHTML = '<div style="padding:10px; color:red; text-align:center;">Data Error: Please Scan Again</div>';
            return;
        }

        const qOrder = sData.seriesOrder[set]; 
        const optCfg = sData.seriesOptionOrder ? sData.seriesOptionOrder[set] : null;

        qOrder.forEach((qIndex, idx) => {
            const qData = sData.questions[qIndex - 1]; 
            if(!qData) return;

            const userAnsChar = detectedAnswers[idx]; 
            
            // Shuffling Pattern
            let pat = [0,1,2,3,4];
            if (optCfg) {
                pat = (Array.isArray(optCfg) ? optCfg : (optCfg[qData.id] || optCfg['default'] || pat));
            }

            const qDiv = document.createElement('div');
            qDiv.className = 'q-block';

            let qStatus = qData.deleted ? '<span class="badge-del">DELETED</span>' : '';
            qDiv.innerHTML = `<div class="q-text">Q${idx+1}. ${qData.question} ${qStatus}</div>`;
            
            const optDiv = document.createElement('div');
            optDiv.className = 'q-opts';

            optionsList.forEach((label, labelIdx) => { 
                const originalOptIdx = pat[labelIdx]; 
                if(!qData.options || !qData.options[originalOptIdx]) return;

                const optText = qData.options[originalOptIdx];
                const cleanOptText = optText.replace(/^[A-E]\)\s*/, ''); 
                const correctAnsClean = qData.answer.replace(/^[A-E]\)\s*/, '').trim();
                
                let rowClass = 'opt-row';
                let icon = '<i class="far fa-circle"></i>';

                // --- MAIN LOGIC CHANGE HERE ---
                const isUserSelected = (userAnsChar === label);
                const isCorrect = (cleanOptText.trim() === correctAnsClean);
                const isOptionE = (label === 'E'); 

                if (isUserSelected) {
                    if (isOptionE) {
                        // CASE 1: User Selected 'E' -> ALWAYS BLUE (No Red, No Green)
                        rowClass += ' opt-skipped'; 
                        icon = '<i class="fas fa-dot-circle"></i>'; // Dot Icon
                    } 
                    else if (isCorrect) {
                        // CASE 2: User Correct
                        rowClass += ' opt-correct'; 
                        icon = '<i class="fas fa-check-circle"></i>';
                    } 
                    else {
                        // CASE 3: User Wrong (Only for A, B, C, D)
                        rowClass += ' opt-wrong'; 
                        icon = '<i class="fas fa-times-circle"></i>';
                    }
                } 
                else if (isCorrect) {
                    // CASE 4: Correct Answer (Show Green if user missed it)
                    rowClass += ' opt-correct'; 
                    icon = '<i class="fas fa-check"></i>';
                    optDiv.style.borderLeft = "3px solid #16a34a"; 
                }

                const row = document.createElement('div');
                row.className = rowClass;
                row.innerHTML = `<span style="width:15px;">${icon}</span> <b>${label})</b> <span>${cleanOptText}</span>`;
                optDiv.appendChild(row);
            });

            qDiv.appendChild(optDiv);
            container.appendChild(qDiv);
        });
    }
  async function downloadOMR() {
        if(!foundOMRUrl) return alert("No image found!");

        // 1. Button Feedback (User ko pata chale process ho rha h)
        const btn = document.querySelector('button[onclick="downloadOMR()"]');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Saving...';
        btn.disabled = true;

        try {
            // 2. High Quality Proxy URL (q=100 for Max Quality)
            // Hum Proxy use kar rhe h taki "CORS" issue na aaye aur download force ho sake
            const hqUrl = `https://wsrv.nl/?url=${encodeURIComponent(foundOMRUrl)}&output=jpg&q=100`;

            // 3. Image ko Blob (File) me convert karna
            const response = await fetch(hqUrl);
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);

            // 4. Filename generate karna (Roll Number ke sath)
            const rollNo = document.getElementById('inp-online-roll').value || "OMR";
            const fileName = `OMR_Sheet_${rollNo}.jpg`;

            // 5. Force Download Trigger
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = fileName; // Ab browser is naam se download karega
            document.body.appendChild(link);
            link.click();
            
            // 6. Cleanup
            document.body.removeChild(link);
            URL.revokeObjectURL(blobUrl);

            // Success Feedback
            btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
            setTimeout(() => { 
                btn.innerHTML = originalContent; 
                btn.disabled = false; 
            }, 2000);

        } catch (error) {
            console.error("Download failed:", error);
            alert("High Quality download failed. Opening in new tab instead.");
            // Fallback: Agar fail ho jaye to purana tarika
            window.open(foundOMRUrl, '_blank');
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }
  // 1. Popup Open Function
    function openRollPopup() {
        const currentRoll = document.getElementById('res-roll').innerText;
        document.getElementById('popup-roll-inp').value = currentRoll.replace(/\D/g,''); // Sirf numbers
        document.getElementById('rollPopup').style.display = 'flex';
        document.getElementById('popup-roll-inp').focus();
    }

    // 2. Submit & Re-Check Function
    function submitRollUpdate() {
        const newRoll = document.getElementById('popup-roll-inp').value.trim();
        
        if(!newRoll || newRoll.length < 5) {
            alert("Please enter valid Roll Number");
            return;
        }

        // A. UI Update
        document.getElementById('res-roll').innerText = newRoll;
        document.getElementById('rollPopup').style.display = 'none';
        
        // B. Data Fetch (Online Data)
        getStudentData(newRoll);

        // C. Shift Calculation & OMR Re-check
        let rNum = parseInt(newRoll);
        let shift = SHIFT_RANGES.find(s => rNum >= s.min && rNum <= s.max);

        if(shift) {
            document.getElementById('res-shift').innerText = shift.label;
            document.getElementById('res-shift').style.background = '#595FFF';
            
            // Re-run checking logic with new Shift Data
            if(typeof allShiftData !== 'undefined') {
                autoCalculateBestSet(allShiftData[shift.id]);
                
                // User Feedback
                const msg = document.createElement('div');
                msg.innerHTML = `<div style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#16a34a; color:white; padding:10px 20px; border-radius:30px; z-index:10000; font-weight:bold; box-shadow:0 5px 15px rgba(0,0,0,0.2);">
                    <i class="fas fa-check-circle"></i> Result Updated!
                </div>`;
                document.body.appendChild(msg);
                setTimeout(() => msg.remove(), 2500);
            }
        } else {
            document.getElementById('res-shift').innerText = "Unknown Shift";
            document.getElementById('res-shift').style.background = '#fee2e2';
            alert("Warning: This Roll Number is outside known Shift ranges.");
        }
    }
  // --- FINAL POPUP FIX (GLOBAL SCOPE) ---

    // 1. Popup Open Function (Global)
    window.openRollPopup = function() {
        const rollEl = document.getElementById('res-roll');
        if(!rollEl) return;
        
        const currentRoll = rollEl.innerText.replace(/\D/g,'');
        const popup = document.getElementById('rollPopup');
        const inp = document.getElementById('popup-roll-inp');
        
        if(popup && inp) {
            inp.value = currentRoll;
            popup.style.display = 'flex';
            setTimeout(() => inp.focus(), 100);
        } else {
            alert("Error: Popup HTML missing!");
        }
    };

    // 2. Submit & Re-Process Function
    window.submitRollUpdate = function() {
        const inp = document.getElementById('popup-roll-inp');
        const newRoll = inp.value.trim();
        
        if(!newRoll || newRoll.length < 5) {
            alert("Please enter valid Roll Number");
            return;
        }

        // A. UI Update (Screen par naya roll number dikhayein)
        document.getElementById('res-roll').innerText = newRoll;
        document.getElementById('rollPopup').style.display = 'none';
        
        // B. Data Fetch (Server se naam/pita ka naam layein)
        if(typeof getStudentData === 'function') getStudentData(newRoll);

        // C. RE-PROCESS OMR (Ye hai main Manual Fix logic)
        // Naye Roll Number se Shift pata karein aur OMR dubara check karein
        let rNum = parseInt(newRoll);
        if(typeof SHIFT_RANGES !== 'undefined') {
            let shift = SHIFT_RANGES.find(s => rNum >= s.min && rNum <= s.max);

            if(shift) {
                document.getElementById('res-shift').innerText = shift.label;
                document.getElementById('res-shift').style.background = '#595FFF';
                
                // DATA RE-CALCULATION TRIGGER
                if(typeof allShiftData !== 'undefined' && allShiftData[shift.id]) {
                    autoCalculateBestSet(allShiftData[shift.id]);
                    
                    // Success Message
                    const msg = document.createElement('div');
                    msg.innerHTML = `<div style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#16a34a; color:white; padding:10px 20px; border-radius:30px; z-index:10000; font-weight:bold; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
                        <i class="fas fa-check-circle"></i> Result Updated!
                    </div>`;
                    document.body.appendChild(msg);
                    setTimeout(() => msg.remove(), 2500);
                }
            } else {
                document.getElementById('res-shift').innerText = "Unknown Shift";
                document.getElementById('res-shift').style.background = '#fee2e2';
                alert("Roll Number shift range se bahar hai, lekin update kar diya gaya hai.");
            }
        }
    };
</script>
<script>if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');</script>
</body>
</html>
